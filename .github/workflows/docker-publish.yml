name: Build and Push RogueLearn.User Docker Image

on:
  push:
    branches:
      - main
    paths:
      - 'src/RogueLearn.User.Api/**'
      - 'building_blocks/**'
      - 'src/**'
      - '.github/workflows/docker-publish.yml'
  workflow_dispatch:
    inputs:
      bump_strategy:
        description: 'Version bump type: patch | minor | major (default: patch)'
        required: false
        default: 'patch'
      base_version:
        description: 'Optional base version to bump from (e.g., v1.0.7). If omitted, the workflow will detect the latest v1.x.x tag.'
        required: false
        default: ''

concurrency:
  group: docker-publish-${{ github.ref }}
  cancel-in-progress: false

jobs:
  docker:
    name: Build and Push
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      IMAGE_NAME: soybean2610/roguelearn-user
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Determine next v1.x.x tag
        id: version
        env:
          BUMP: ${{ inputs.bump_strategy || 'patch' }}
          BASE_VERSION: ${{ inputs.base_version }}
          REPO: soybean2610/roguelearn-user
        shell: bash
        run: |
          set -eo pipefail
          sudo apt-get update -y && sudo apt-get install -y jq

          # Prefer Git tags (fast, avoids Docker Hub API auth). Fallback to Docker Hub tags if none found.
          git fetch --tags --force || true
          GIT_TAGS=$(git tag -l 'v1.*' || true)

          if [ -n "$BASE_VERSION" ]; then
            CURRENT="$BASE_VERSION"
            echo "Using provided base_version: $CURRENT"
          elif [ -n "$GIT_TAGS" ]; then
            CURRENT=$(echo "$GIT_TAGS" | grep -E '^v1\.[0-9]+\.[0-9]+$' | sort -V | tail -n1)
            echo "Latest repo tag: $CURRENT"
          else
            echo "No repo tags found, checking Docker Hub for existing image tags..."
            TAGS_JSON=$(curl -s "https://hub.docker.com/v2/repositories/${REPO}/tags/?page_size=100")
            CURRENT=$(echo "$TAGS_JSON" | jq -r '.results[].name' | grep -E '^v1\.[0-9]+\.[0-9]+$' | \
              awk -F'[v.]' '{printf "%s.%s.%s %s\n",$2,$3,$4,$0}' | sort -t. -k1,1n -k2,2n -k3,3n | tail -n1 | awk '{print $2}')
            if [ -z "$CURRENT" ]; then
              CURRENT="v1.0.0"
            fi
            echo "Latest registry tag: $CURRENT"
          fi

          MAJOR=$(echo "$CURRENT" | sed -E 's/^v([0-9]+)\.[0-9]+\.[0-9]+$/\1/')
          MINOR=$(echo "$CURRENT" | sed -E 's/^v[0-9]+\.([0-9]+)\.[0-9]+$/\1/')
          PATCH=$(echo "$CURRENT" | sed -E 's/^v[0-9]+\.[0-9]+\.([0-9]+)$/\1/')

          case "$BUMP" in
            patch) PATCH=$((PATCH + 1));;
            minor) MINOR=$((MINOR + 1)); PATCH=0;;
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0;;
            *) PATCH=$((PATCH + 1));; # default
          esac

          NEXT="v${MAJOR}.${MINOR}.${PATCH}"
          echo "next_tag=$NEXT" >> "$GITHUB_OUTPUT"
          echo "Resolved next tag: $NEXT"

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: src/RogueLearn.User.Api/Dockerfile
          push: true
          platforms: linux/amd64
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.next_tag }}

      - name: Summary
        run: |
          echo "Image pushed: $IMAGE_NAME:${{ steps.version.outputs.next_tag }}"